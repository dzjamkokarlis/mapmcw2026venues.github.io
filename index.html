<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Festival Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body { 
  height: 100%; 
  margin: 0; 
  font-family: 'Open Sans', Arial, sans-serif;
  overflow: hidden;
  touch-action: pan-y;
}

body { 
  display: flex; 
  flex-direction: column;
  height: 100vh;
}

#map { 
  flex: 1;
  width: 100%;
  min-height: 50vh;
  z-index: 1;
}

/* Mobile bottom sheet style panel */
#list-panel { 
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: 45vh;
  background: #f4f1ed;
  border-top: 1px solid #ccc;
  display: flex;
  flex-direction: column;
  z-index: 1000;
  transition: transform 0.3s ease;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
}

#panel-handle {
  display: flex;
  justify-content: center;
  padding: 8px;
  background: #e8e3ef;
  border-bottom: 1px solid #ddd;
  cursor: grab;
}

#panel-handle::before {
  content: "";
  width: 40px;
  height: 4px;
  background: #999;
  border-radius: 2px;
}

#list-panel.collapsed {
  transform: translateY(calc(100% - 50px));
}

#list-header { 
  position: relative; 
  background-size: cover; 
  background-position: center; 
  color: white; 
  padding: 12px 16px; 
  flex-shrink: 0;
}

#list-header::before { 
  content: ""; 
  position: absolute; 
  inset: 0; 
  background: rgba(0,0,0,0.5); 
  z-index: 0;
}

#list-header > * { 
  position: relative; 
  z-index: 1; 
}

#header-top { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
  gap: 12px;
  margin-bottom: 10px;
}

#title-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

#logo-slot { 
  width: 100px; 
  height: 50px; 
  flex-shrink: 0;
}

#logo-slot img { 
  max-width: 100%; 
  max-height: 100%; 
  object-fit: contain; 
}

.font-chamber { font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif; }
.font-masters { font-family: "Clarendon BT", "Clarendon", "Rockwell", serif; font-weight: 700; }
.font-literary { font-family: "Museo", "Open Sans", sans-serif; font-weight: 500; }

#header-title {
  margin: 0;
  font-size: 1.1rem;
  line-height: 1.2;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
}

#header-subtitle {
  font-size: 0.85rem;
  opacity: 0.9;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

#button-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#festival-buttons { 
  display: flex; 
  flex-wrap: wrap;
  gap: 6px; 
}

/* Touch-friendly buttons - min 44px */
#festival-buttons button { 
  background: rgba(255,255,255,0.25); 
  border: 1px solid rgba(255,255,255,0.5); 
  color: white; 
  padding: 10px 14px; 
  border-radius: 6px; 
  cursor: pointer; 
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
  min-height: 44px;
  touch-action: manipulation;
}

#festival-buttons button:hover,
#festival-buttons button:active {
  background: rgba(255,255,255,0.4);
  transform: scale(0.98);
}

#festival-buttons button.active { 
  background: rgba(255,255,255,0.8); 
  border-color: white; 
  font-weight: bold; 
  color: #222;
}

#secondary-buttons { 
  display: none; 
  gap: 8px;
}

#secondary-buttons.visible { 
  display: flex; 
}

#secondary-buttons button { 
  background: #ff6b6b; 
  border: 1px solid #ff5252; 
  color: white; 
  padding: 10px 14px; 
  border-radius: 6px; 
  cursor: pointer; 
  font-weight: bold; 
  font-size: 0.85rem;
  min-height: 44px;
  touch-action: manipulation;
  flex: 1;
}

#secondary-buttons button:active {
  background: #ff5252;
  transform: scale(0.98);
}

#secondary-buttons button.active { 
  background: #ff4757; 
  box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); 
}

#list { 
  flex: 1; 
  overflow-y: auto; 
  padding: 8px;
  -webkit-overflow-scrolling: touch;
}

.location { 
  padding: 16px 12px; 
  border-bottom: 1px solid #ddd; 
  cursor: pointer; 
  transition: background 0.2s;
  min-height: 44px;
  display: flex;
  align-items: center;
  font-size: 0.95rem;
}

.location:hover,
.location:active {
  background: #e8e3ef;
}

.location.box-office { 
  background: #fff3cd; 
  border-left: 5px solid #d39e00; 
  font-weight: 600; 
}

.location.fringe-venue { 
  background: #ffe0e0; 
  border-left: 5px solid #ff6b6b; 
}

.location.fringe-venue:active { 
  background: #ffd0d0; 
}

.map-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.map-control-btn {
  width: 44px;
  height: 44px;
  background: white;
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  cursor: pointer;
  touch-action: manipulation;
}

.map-control-btn:active {
  background: #f0f0f0;
  transform: scale(0.95);
}

.leaflet-popup-content-wrapper {
  max-width: 280px;
}

.popup img { 
  width: 100%; 
  margin-top: 8px; 
  border-radius: 4px; 
  cursor: pointer; 
}

.popup a { 
  display: inline-block; 
  margin-top: 8px; 
  padding: 10px 16px;
  background: #1a73e8;
  color: white;
  font-weight: bold; 
  text-decoration: none; 
  border-radius: 6px;
  min-height: 44px;
  line-height: 24px;
}

.popup a:active {
  background: #1557b0;
}

/* Desktop styles */
@media (min-width: 769px) {
  body { 
    flex-direction: row;
  }
  
  #map { 
    width: 65%; 
    height: 100vh;
    min-height: auto;
  }
  
  #list-panel { 
    position: relative;
    width: 35%; 
    height: 100vh;
    border-top: none;
    border-left: 1px solid #ccc;
    box-shadow: none;
    transform: none !important;
  }
  
  #panel-handle {
    display: none;
  }
  
  #header-title {
    font-size: 1.3rem;
  }
  
  .location {
    padding: 14px 12px;
  }
}

@media (max-width: 380px) {
  #header-title {
    font-size: 1rem;
  }
  
  #festival-buttons button {
    padding: 8px 10px;
    font-size: 0.8rem;
  }
}

@media (max-width: 768px) and (orientation: landscape) {
  #list-panel {
    height: 35vh;
  }
}
</style>
</head>
<body>
<div id="map"></div>

<div id="list-panel">
  <div id="panel-handle"></div>
  <div id="list-header">
    <div id="header-top">
      <div id="title-section">
        <h2 id="header-title" class="font-chamber">West Cork Chamber Music Festival</h2>
        <span id="header-subtitle">2026 Festival Venues</span>
      </div>
      <div id="logo-slot"><img id="festival-logo" src="" alt="Festival Logo"></div>
    </div>
    <div id="button-container">
      <div id="festival-buttons">
        <button data-festival="chamber" class="active">Chamber Festival</button>
        <button data-festival="masters">Masters of Tradition</button>
        <button data-festival="literary">Literary Festival</button>
      </div>
      <div id="secondary-buttons">
        <button id="extra-venues-btn">+ Show Fringe Venues</button>
      </div>
    </div>
  </div>
  <div id="list"></div>
</div>

<div class="map-controls">
  <button class="map-control-btn" id="fullscreen-btn" title="Toggle Fullscreen">‚õ∂</button>
  <button class="map-control-btn" id="locate-btn" title="My Location">üìç</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert("Image address copied");
  });
}

const placeholderImage = "https://via.placeholder.com/400x250?text=Venue+Image";
const festivalData = {
  chamber: {
    name: "West Cork Chamber Music Festival",
    fontClass: "font-chamber",
    image: "https://www.westcorkmusic.ie/wp-content/uploads/2026/01/music.jpg",
    logo: "https://www.westcorkmusic.ie/wp-content/uploads/2024/04/WCCMF-Logo-2024-158-px-x-70-px-2.png",
    locations: [
      { name: "St Brendans School Hall", lat: 51.68151, lng: -9.45476, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-stbrendans-school.jpg" },
      { name: "St. Brendan's Church", lat: 51.68092352594685, lng: -9.453272648886415, image: "https://www.westcorkmusic.ie/wp-content/uploads/2024/09/CS-Prog-2024-Uber-Menu.jpg" },
      { name: "Cork County Council, (Courthouse)", lat: 51.68113143041356, lng: -9.45383702947407, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-courthouse.jpg" },
      { name: "Bantry Christian Fellowship Church", lat: 51.67990, lng: -9.45608, image: placeholderImage },
      { name: "Bantry pier", lat: 51.68068981445563, lng: -9.462039897786067, image: placeholderImage },
      { name: "Bantry Tourist Information Office", lat: 51.68020080895369, lng: -9.452257798189326, image: "https://di262mgurvkjm.cloudfront.net/01980b2b-c294-71cd-bffb-a18eee038ced/REPRO_FREE_Bantry_wclf_14.07.2025_KD__xgaplus.jpg" },
      { name: "The Brick Oven, Bantry", lat: 51.6803958090618, lng: -9.45507917673037, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-the-brick-oven-1.jpg" },
      { name: "The Maritime Hotel, Bantry", lat: 51.680142214673765, lng: -9.457270046457491, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-maritime-hotel-1.jpg" },
      { name: "Bantry House", lat: 51.677507790279954, lng: -9.46437614203052, image: "https://www.westcorkmusic.ie/wp-content/uploads/2019/03/Bantry-House-Gardens.jpg" },
      { name: "Marino Church, Bantry", lat: 51.68053728946514, lng: -9.45178212483789, image: "https://www.westcorkmusic.ie/wp-content/uploads/2022/08/Marino-Old-Methodist-Church.jpg" },
      { name: "West Cork Music Box Office [BOX OFFICE]", lat: 51.68051340859633, lng: -9.448561083049437, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/wcm-office-2024.jpg" }
    ],
    extraLocations: [
      { name: "Cork Airport", lat: 51.84907893547716, lng: -8.489884499961821, image: "http://www.corkairport.com/images/default-source/default-album/cork-airport_ext-(11).jpg?sfvrsn=0" },
      { name: "Levis' Corner House, Ballydehob", lat: 51.56261786584987, lng: -9.460362992725443, image: "https://www.westcorkmusic.ie/wp-content/uploads/2022/06/Levis-Corner-House.jpg" },
      { name: "Wild Atlantic Glamping Bere Island", lat: 51.63931443722968, lng: -9.828050693647242, image: placeholderImage },
      { name: "Durrus Festival Philips Green, Durrus", lat: 51.62201528419279, lng: -9.522333136708495, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/12/venue-philipsgreen-durrus.jpg" },
      { name: "Uillinn West Cork Arts Centre, Skibbereen", lat: 51.54885618015605, lng: -9.267398339943322, image: placeholderImage },
      { name: "Amar's Caf√©, Schull", lat: 51.52706766730389, lng: -9.54664737698778, image: "https://www.westcorkmusic.ie/wp-content/uploads/2025/04/Amars-Cafe_low-res.jpg" },
      { name: "Sherkin Island Community Hall", lat: 51.47348470163226, lng: -9.40685703916773, image: placeholderImage },
      { name: "Two Green Shoots, Glengarriff", lat: 51.77748667310069, lng: -9.56908695929444, image: placeholderImage },
      { name: "Maritime Hotel, Bantry", lat: 51.68016210654624, lng: -9.457257914368327, image: placeholderImage },
      { name: "Arundels-by-the-Pier", lat: 51.59999472066557, lng: -9.632374680466265, image: "https://www.westcorkmusic.ie/wp-content/uploads/2022/06/Arundels-by-the-Pier.jpg" },
      { name: "Wolfe Tone Square, Bantry", lat: 51.68053285256902, lng: -9.453626886980139, image: "https://di262mgurvkjm.cloudfront.net/01963fc9-fbab-7af2-a072-6b426a137b00/Bantry_West_Cork_Literaryf_2024_KD_-25_uxga.jpg" },
      { name: "Whiddy Island", lat: 51.69170925129019, lng: -9.490732608889365, image: "https://di262mgurvkjm.cloudfront.net/0197d7ad-6bc9-75cf-ade4-cd141e438ad2/SPEC_WCCMF_2025_day_8_KD_-16_xgaplus.jpg" },
      { name: "Heir Island (Take the ferry from Cunnamore Point)", lat: 51.49481839448013, lng: -9.439318239788358, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/12.-Magnolia-Quartet-on-Heir-Island_c.Maria-Sheil-2-2048x1386.jpeg" }
    ]
  },
  masters: {
    name: "Masters of Tradition",
    fontClass: "font-masters",
    image: "https://www.westcorkmusic.ie/wp-content/uploads/2026/01/WCM-Website-banners-3.jpg",
    logo: "https://www.westcorkmusic.ie/wp-content/uploads/2024/04/MOT-Logo-2024-158-px-x-70-px.png",
    locations: [
      { name: "St. Brendan's Church", lat: 51.68092352594685, lng: -9.453272648886415, image: "https://di262mgurvkjm.cloudfront.net/01970eef-2f33-7f3b-ba74-3eaeb4a5b6b6/DJI_0272_xlarge.jpg" },
      { name: "Bantry House", lat: 51.677507790279954, lng: -9.46437614203052, image: "https://di262mgurvkjm.cloudfront.net/0198d468-f529-761a-963b-aebfc868f5e1/MOT_23.08.2025_KD_aerial_xgaplus.jpg" },
      { name: "Maritime Hotel, Bantry", lat: 51.68120, lng: -9.457185745588363, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-maritime-hotel-1.jpg" },
      { name: "Marino Church, Bantry", lat: 51.68055452005309, lng: -9.451873316297892, image: "https://di262mgurvkjm.cloudfront.net/01963c0c-f3ff-7f31-b44b-0facabbebc82/Bantry_west_cork_literary_2025_KD_-28_uxga.jpg" },
      { name: "Bantry Pier", lat: 51.68067621775035, lng: -9.462015915543367, image: placeholderImage },
      { name: "Future Forests", lat: 51.78700, lng: -9.47300, image: "https://www.westcorkmusic.ie/wp-content/uploads/2022/07/Future-Forests-2.jpg" },
      { name: "West Cork Music Box Office [BOX OFFICE]", lat: 51.68400, lng: -9.44900, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/wcm-office-2024.jpg" }
    ]
  },
  literary: {
    name: "West Cork Literary Festival",
    fontClass: "font-literary",
    image: "https://www.westcorkmusic.ie/wp-content/uploads/2024/09/DSC_7560-scaled-1200x483.jpg",
    logo: "https://www.westcorkmusic.ie/wp-content/uploads/2025/04/WCLF-Header-Logo-for-Website-158px-x-70px.png",
    locations: [
      { name: "Bantry Pier", lat: 51.68067621775035, lng: -9.462015915543367, image: placeholderImage },
      { name: "Abbey Strand, Bantry (Festival Swim)", lat: 51.67727912421127, lng: -9.47164608704743, image: "https://www.westcorkmusic.ie/wp-content/uploads/2024/04/IMG-20230709-WA0022-e1712109335556.jpg" },
      { name: "Bantry House", lat: 51.677507790279954, lng: -9.46437614203052, image: "https://www.bantry.ie/wp-content/uploads/Bantry-House-3.jpg" },
      { name: "Maritime Hotel, Bantry", lat: 51.680207147514025, lng: -9.457185745588363, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-maritime-hotel-1.jpg" },
      { name: "St Brendans School Hall", lat: 51.68145405559759, lng: -9.454600199562845, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/venue-stbrendans-school.jpg" },
      { name: "National Learning Network, Bantry", lat: 51.69961003492131, lng: -9.442026764671246, image: "https://www.westcorkmusic.ie/wp-content/uploads/2019/02/1-venues-nlnbantry.jpg" },
      { name: "Future Forests", lat: 51.78700, lng: -9.47300, image: "https://www.westcorkmusic.ie/wp-content/uploads/2022/07/Future-Forests-2.jpg" },
      { name: "Marino Church, Bantry", lat: 51.68055452005309, lng: -9.451873316297892, image: "https://www.westcorkmusic.ie/wp-content/uploads/2022/08/Marino-Old-Methodist-Church.jpg" },
      { name: "Ma Murphy's Bar, Bantry", lat: 51.67947496316963, lng: -9.450857572290625, image: "https://di262mgurvkjm.cloudfront.net/019805e5-de15-72e9-968f-c6b4997fd3f8/REPRO_FREE_Bantry_wclf_13.07.2025_KD_-29_xgaplus.jpg" },
      { name: "Bantry Library", lat: 51.67849899238629, lng: -9.449377866282619, image: "https://www.westcorkmusic.ie/wp-content/uploads/2024/08/DSC_1827.jpg" },
      { name: "St Finbarr's Boys School, Bantry", lat: 51.67694029272779, lng: -9.441044480425049, image: "https://www.westcorkmusic.ie/wp-content/uploads/2023/03/St-Finbarres-Boys-NS.jpeg" },
      { name: "Bantry Bookshop", lat: 51.67969046251881, lng: -9.452045862683947, image: "https://di262mgurvkjm.cloudfront.net/01963c33-e981-730a-87c4-58ec197f5703/Bantry_west_cork_literary_2025_KD_-4_bigthumb.jpg" },
      { name: "West Cork Music Box Office [BOX OFFICE]", lat: 51.68400, lng: -9.44900, image: "https://www.westcorkmusic.ie/wp-content/uploads/2018/11/wcm-office-2024.jpg" }
    ]
  }
};

const map = L.map("map", {
  zoomControl: false,
  tap: true,
  touchZoom: true,
  scrollWheelZoom: false,
  dragging: true
}).setView([51.68, -9.45], 13);

L.control.zoom({ position: 'topright' }).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let markers = [];
let extraMarkers = [];
let currentFestival = null;
let showingExtra = false;

function popupHTML(loc) {
  const link = `https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}`;
  return `<div class="popup">
    <strong>${loc.name}</strong><br>
    <img src="${loc.image}" data-img="${loc.image}">
    <a href="${link}" target="_blank">üìç Get directions</a>
  </div>`;
}

function loadFestival(key) {
  currentFestival = key;
  const data = festivalData[key];
  
  document.getElementById("list-header").style.backgroundImage = `url(${data.image})`;
  document.getElementById("festival-logo").src = data.logo;
  
  const titleEl = document.getElementById("header-title");
  titleEl.className = data.fontClass;
  titleEl.textContent = data.name;
  
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  extraMarkers.forEach(m => map.removeLayer(m));
  extraMarkers = [];
  
  showingExtra = false;
  const extraBtn = document.getElementById("extra-venues-btn");
  extraBtn.textContent = "+ Show Fringe Venues";
  extraBtn.classList.remove("active");
  
  const secondaryContainer = document.getElementById("secondary-buttons");
  if (key === "chamber" && data.extraLocations) {
    secondaryContainer.classList.add("visible");
  } else {
    secondaryContainer.classList.remove("visible");
  }
  
  document.querySelectorAll("#festival-buttons button").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.festival === key);
  });
  
  const list = document.getElementById("list");
  list.innerHTML = "";
  
  const bounds = L.latLngBounds([]);
  
  data.locations.forEach(loc => {
    const marker = L.marker([loc.lat, loc.lng])
      .addTo(map)
      .bindPopup(popupHTML(loc));
    marker.on("popupopen", e => {
      const img = e.popup.getElement().querySelector("img");
      if (img) {
        img.onclick = () => copyToClipboard(img.dataset.img);
      }
    });
    markers.push(marker);
    bounds.extend([loc.lat, loc.lng]);
    
    const item = document.createElement("div");
    item.className = "location";
    item.textContent = loc.name;
    if (loc.name.toUpperCase().includes("BOX OFFICE")) {
      item.classList.add("box-office");
    }
    item.onclick = () => {
      map.setView([loc.lat, loc.lng], 16);
      marker.openPopup();
      if (window.innerWidth <= 768) {
        document.getElementById("list-panel").classList.add("collapsed");
      }
    };
    list.appendChild(item);
  });
  
  map.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 });
}

function toggleExtraVenues() {
  const data = festivalData.chamber;
  if (!data.extraLocations) return;
  
  showingExtra = !showingExtra;
  const btn = document.getElementById("extra-venues-btn");
  const list = document.getElementById("list");
  
  if (showingExtra) {
    btn.textContent = "‚àí Hide Fringe Venues";
    btn.classList.add("active");
    
    const bounds = L.latLngBounds([]);
    markers.forEach(m => bounds.extend(m.getLatLng()));
    
    data.extraLocations.forEach(loc => {
      const marker = L.circleMarker([loc.lat, loc.lng], {
        radius: 8,
        fillColor: "#ff6b6b",
        color: "#fff",
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map).bindPopup(popupHTML(loc));
      
      marker.on("popupopen", e => {
        const img = e.popup.getElement().querySelector("img");
        if (img) {
          img.onclick = () => copyToClipboard(img.dataset.img);
        }
      });
      
      extraMarkers.push(marker);
      bounds.extend([loc.lat, loc.lng]);
      
      const item = document.createElement("div");
      item.className = "location fringe-venue";
      item.textContent = loc.name;
      item.onclick = () => {
        map.setView([loc.lat, loc.lng], 16);
        marker.openPopup();
        if (window.innerWidth <= 768) {
          document.getElementById("list-panel").classList.add("collapsed");
        }
      };
      list.appendChild(item);
    });
    
    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
    
  } else {
    btn.textContent = "+ Show Fringe Venues";
    btn.classList.remove("active");
    
    extraMarkers.forEach(m => map.removeLayer(m));
    extraMarkers = [];
    
    const fringeItems = list.querySelectorAll(".fringe-venue");
    fringeItems.forEach(item => item.remove());
  }
}

let isDragging = false;
let startY = 0;
let currentY = 0;
const panel = document.getElementById("list-panel");
const handle = document.getElementById("panel-handle");

handle.addEventListener("touchstart", (e) => {
  isDragging = true;
  startY = e.touches[0].clientY;
  handle.style.cursor = "grabbing";
}, { passive: true });

handle.addEventListener("touchmove", (e) => {
  if (!isDragging) return;
  currentY = e.touches[0].clientY;
  const diff = currentY - startY;
  
  if (diff > 50) {
    panel.classList.add("collapsed");
    isDragging = false;
  } else if (diff < -50) {
    panel.classList.remove("collapsed");
    isDragging = false;
  }
}, { passive: true });

handle.addEventListener("touchend", () => {
  isDragging = false;
  handle.style.cursor = "grab";
}, { passive: true });

handle.addEventListener("click", () => {
  panel.classList.toggle("collapsed");
});

document.getElementById("fullscreen-btn").onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
};

document.getElementById("locate-btn").onclick = () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setView([lat, lng], 14);
        L.marker([lat, lng], {
          icon: L.divIcon({
            className: 'user-location',
            html: '<div style="background:#1a73e8;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
            iconSize: [22, 22]
          })
        }).addTo(map).bindPopup("Your location").openPopup();
      },
      (err) => {
        alert("Unable to get your location");
      }
    );
  }
};

document.querySelectorAll("#festival-buttons button").forEach(btn => {
  btn.onclick = () => loadFestival(btn.dataset.festival);
});

document.getElementById("extra-venues-btn").onclick = toggleExtraVenues;

window.addEventListener("resize", () => {
  map.invalidateSize();
  if (window.innerWidth > 768) {
    panel.classList.remove("collapsed");
  }
});

loadFestival("chamber");
</script>
</body>
</html>